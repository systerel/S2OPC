# Continuous Integration configuration with gitlab.com
# See https://gitlab.com/help/ci/yaml/README.md

stages:
  - gen
  - build
  - tis-analysis
  - test
  - build-cc

generation:
  stage: gen
  image: com2.systerel.fr:5000/c765/gen-ext@sha256:07833aaecbb6de901f2216862d11b96d65b3b0462c3fe9353a951b3c609c6137 # gen-ext:1.1
  script:
    - ./.pre-build-ext.sh
  # only:
  #   - master
  tags:
    - docker
    - linux
  artifacts:
    name: 'bgenc-${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}'
    paths:
      - 'address_space_generation/genc'
      - 'csrc/services/bgenc'
    expire_in: '1 month'

build-linux64:
  stage: build
  image: registry.gitlab.com/systerel/s2opc/build@sha256:8e139a7e9077ef150639b7d772e2b6caf41a34c9c10d97d194140c2588665c81  # build:1.3
  script:
    - './build.sh && cd build && cmake --build . --target install'
  variables:
    CMAKE_INSTALL_PREFIX: '../install_linux64'
    DOCKER_IMAGE: 'sha256:e6ef818bf9d8a244afdf2558bac405719a2b73ca1e154de635502988ab48f49c'
  # only:
  #   - master
  tags:
    - docker
    - linux
  artifacts:
    name: 'bin-${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}'
    paths:
      - 'bin/'
      - 'install_linux64/'
      - 'csrc/configuration/sopc_toolkit_build_info.h' # for tis-analysis only
    expire_in: '1 month'

build-win32:
  stage: build-cc
  image: registry.gitlab.com/systerel/s2opc/mingw_build@sha256:749abd06fac07c9fbc3e3e4b2dd18ff5e3c974371d1a2094252432ea6fe2d6af  # mingw_build:1.3
  script:
    - './build.sh && cd build_toolchain && cmake --build . --target install'
  variables:
    CMAKE_INSTALL_PREFIX: '../install_win32'
    DOCKER_IMAGE: 'sha256:ed2d22733470f050c03edc72f5ff68a364c392523599df5661337f689f19516d'
    CMAKE_TOOLCHAIN_FILE: 'toolchain-mingw32-w64.cmake'
    BUILD_SHARED_LIBS: 'true'
  # only:
  #   - master
  except:
    - TrustInSoft_Analysis
  tags:
    - docker
    - linux
  artifacts:
    name: 'bin-w32-${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}'
    paths:
      - 'bin/'
      - 'install_win32/'
    expire_in: '1 month'

build-win64:
  stage: build-cc
  image: registry.gitlab.com/systerel/s2opc/mingw_build@sha256:749abd06fac07c9fbc3e3e4b2dd18ff5e3c974371d1a2094252432ea6fe2d6af  # mingw_build:1.3
  script:
    - './build.sh && cd build_toolchain && cmake --build . --target install'
  variables:
    CMAKE_INSTALL_PREFIX: '../install_win64'
    DOCKER_IMAGE: 'sha256:ed2d22733470f050c03edc72f5ff68a364c392523599df5661337f689f19516d'
    CMAKE_TOOLCHAIN_FILE: 'toolchain-mingw32-w64_x86_64.cmake'
    BUILD_SHARED_LIBS: 'true'
  # only:
  #   - master
  except:
    - TrustInSoft_Analysis
  tags:
    - docker
    - linux
  artifacts:
    name: 'bin-w64-${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}'
    paths:
      - 'bin/'
      - 'install_win64/'
    expire_in: '1 month'

# Test check belongs to the test part, however it does not depend on linux build.
test-check:
  stage: test
  image: registry.gitlab.com/systerel/s2opc/check@sha256:76e11aaf485bdbbb8f48bc75d5e423370b9c71b0842f3b35de41f85c8aa21530  # check:1.0
  script:
    - ./.check-code.sh
  # only:
  #   - master
  except:
    - TrustInSoft_Analysis
  tags:
    - docker
    - linux
  dependencies:
    - generation

test-unit:
  stage: test
  image: registry.gitlab.com/systerel/s2opc/test@sha256:6a364199c571e62a32d121232729a371a082fc1430941cfd305d0f85817e4518  # test:1.0
  script:
    - ./test-all.sh
  # only:
  #   - master
  except:
    - TrustInSoft_Analysis
  tags:
    - docker
    - linux
  dependencies:
    - build-linux64

test-uactt:
  stage: test
  image: com2.systerel.fr:5000/c765/uactt@sha256:baf2dd81823abe2b4c5777f7a80b1357812c6e4d52c69e295a476630cc2086d7  # uactt:1.0
  script:
    - 'cd acceptances_tests/ && ./launch_acceptance_tests.sh'
  # only:
  #   - master
  except:
    - TrustInSoft_Analysis
  tags:
    - docker
    - linux
  dependencies:
    - build-linux64

tis-analysis:
  stage: tis-analysis
  image: tisa:test
  tags:
    - trustinsoft
  dependencies:
    - generation
    - build-linux64
  only:
    - TrustInSoft_Analysis
  artifacts:
    name: 'tis-analysis-logs-${CI_COMMIT_REF_SLUG}_${CI_COMMIT_SHA}'
    paths:
      - tis-analysis/results/*_check.log
    when: on_failure
    expire_in: '1 month'
  allow_failure: true
  script:
    - 'cd tis-analysis && ./run-analysis.sh'
