/*
 * Licensed to Systerel under one or more contributor license
 * agreements. See the NOTICE file distributed with this work
 * for additional information regarding copyright ownership.
 * Systerel licenses this file to you under the Apache
 * License, Version 2.0 (the "License"); you may not use this
 * file except in compliance with the License. You may obtain
 * a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied.  See the License for the
 * specific language governing permissions and limitations
 * under the License.
 */

#include "check_crypto_certificates.h"

#include <check.h>

#include "hexlify.h"
#include "sopc_mem_alloc.h"

// server_2k_cert.der
const char* SRV_CRT =
    "30820513308202fba00302010202015b300d06092a864886f70d01010b0500308193310b3009060355040613024652310f300d06035504080c"
    "064672616e63653111300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e7475727920436572746966"
    "696361746520417574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70632d737570706f72744073"
    "7973746572656c2e66723020170d3139313131393136303633315a180f32313139313032363136303633315a3066310b300906035504061302"
    "4652310f300d06035504080c064672616e63653111300f060355040a0c08537973746572656c3133303106035504030c2a53324f5043204365"
    "6e7475727920436572746966696361746520666f722054657374205365727665727330820122300d06092a864886f70d01010105000382010f"
    "003082010a02820101009bb3fce0a5805a868035e5b1bbe161af33be4596c9029fe7289e3c4852c9ada105425f96bf732941123e6de1a735cc"
    "644229e895e35ba4180c37efe705f1376be650c8f4c6e126cea0f80d52a033cf7683e127a1e6ae336bb0789c48fe82bd0bc65ac533ea7a6057"
    "39c07376cef6088cf881ee52eb6ae04fc6dc10cd7059a1b8551531721d71486bbb8fba8f1d2898cfca991dff31c71da7f72b08303b453fffbb"
    "171117ecced93309233fe1172fcb6184b76d6d055671ba56d2d561f08ca2828f97c72c10899c603127fc98725a1b8184a1a49b84332400d23d"
    "92f3fd5a8b75905b3facbbf72e3b80cde86abecf506e5f4e751fe2fd3d169eb02d5674efc6af0203010001a3819b308198301d0603551d0e04"
    "1604146745aacc412541d8e1d55021fd83e577a3f4e3ea301f0603551d230418301680147a46cbd22f30a4ff672913393f9c02bf03d0728230"
    "0b0603551d0f0404030204f030130603551d25040c300a06082b0601050507030130090603551d130402300030290603551d11042230208613"
    "75726e3a53324f50433a6c6f63616c686f737482096c6f63616c686f7374300d06092a864886f70d01010b0500038202010009f225681ca8f0"
    "afa48b0d76257ce281b7361057c7a8e19da3cf67fe4673baa15fcf171576dee68f375c053db7ed6606fc9bf46b42a76563e9de4850f1125401"
    "06b88dea652aed1809dafb13ffbf17bb62b0766ca0d47d8d886cd19a1f7504b22c1fc164ff7f854d7e44775c53c6cfdd1f03def6b57c323c3e"
    "13503602a9740880808aa35b073200531044603b25a29af7623068261fdd57b86c3dfb85e5ab5104506e9ded226e5c8c580e80a0b9d2b4d25d"
    "5cedbe011c01ac9adc686781931a87d1ebb55773ef71e834174cf4462545d6ad3697d909c4330f56f47416c409260a57dd01cbe18217a73ce1"
    "2e0fe01eed4b21d43e805395f3a3a404b65d5cd3a0d57cbbfcb6acd97064cce3abb087d566487ec686abce7e9dd707ecc13b91b010d9fbbdd5"
    "772c2db488b5242bbe87edd5daedf389353aaa225bbbf8336a79d19f9de97bcd83957bca12c66029666349aacafadf089db53d20f933146ab5"
    "aaa05caa9b76c4801786f19da9d7a5f509ec3421d0e192da1331fba8dbd9aad9cc858720963ac5fc51b992ee877688ee4288531269057b2d92"
    "b974618af8aa19621d4dea837809f23ed7eeac38f90a265cdedaf6eb01c82247d5e0ae30905c16633560f7405b1db65832121fe884d540a293"
    "23a8952d726e9139ee6f29adcd76bab7197bea16511f9079f50fe8935c184174324dba241a3b6f0d40e8e4e04319a337dc";

const char* SRV_CRT_THUMB = "f4694c21c00fcb3155369d1dfc69baebee209a04";

// cacert.der
#define CA_CRT_DEFINE                                                                                                  \
    "3082060d308203f5a003020102020900a0b70a15c7b77114300d06092a864886f70d01010b0500308193310b300906035504061302465231" \
    "0f300d06035504080c064672616e63653111300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e74" \
    "75727920436572746966696361746520417574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70" \
    "632d737570706f727440737973746572656c2e66723020170d3138313030343135343735375a180f32313138303931303135343735375a30" \
    "8193310b3009060355040613024652310f300d06035504080c064672616e63653111300f060355040a0c08537973746572656c3136303406" \
    "035504030c2d53324f50432043656e7475727920436572746966696361746520417574686f7269747920666f722054657374733128302606" \
    "092a864886f70d010901161973326f70632d737570706f727440737973746572656c2e667230820222300d06092a864886f70d0101010500" \
    "0382020f003082020a0282020100cfd7b7f13562f1c163e6055bc458c6ed53675feb7b7ca0e8688d4c3ad603a5fe5d854d1667691f9e8e35" \
    "03bea1bedccfb6fc58142bd55a379a4c010782df96fb455e467aa785aec3f9d20f86340477c183235533f8d4522e12e0cbcbf4e61cc8f80f" \
    "6266311c8647020a9eb339debb2e9c8887a841b4a172cfaf2084fdeaa4d5d7d33f711b4f2eee441a549b62dad6bd6631221677dede027c85" \
    "b39fdd6461b7e5696a2f8c1d2273de1e4d796cade386008d41a6ee2f540d4823277c049e9c8f3ccfb7f35d8953d862c10e29ffcbb727abe4" \
    "b37735ad069fa2cfa2e9c7344e0a3a0202fccb4a8798bb7e7c6668bc678c29ea5387be9738674228294b99635c57bb376a101d83a655def9" \
    "b298ab56bbee95be80d53e9c2eeffaf44f1fc31ad6aa1d3da59b154eea7e09bbdb897414097b15d0cfe35a7bc85ad85b4c43d8b74befc4df" \
    "fff3731e459035b5d75b288960a7be2f7caedad2fb7f427d9f923bc6e9bb0d6dde17e408e024c3eb44b0d006c37cd5b3353d8579acc3e7c0" \
    "75de712ae6ae819e054012871f43ff3064ac06538c17ac1e7644f3858d62318039e49cf566b40fe3d4e8981fdeacef039e6726312f8612d8" \
    "8da145fdf55d99f5b336bca673938e426bf25638540c2e80c7af5b8522c30795c74b14af1059c62acb0fa79e563cc907a997155654942cdf" \
    "9dafac4fc9c14f66838eb766539d9843ebb5f93506450203010001a360305e301d0603551d0e041604147a46cbd22f30a4ff672913393f9c" \
    "02bf03d07282301f0603551d230418301680147a46cbd22f30a4ff672913393f9c02bf03d07282300f0603551d130101ff040530030101ff" \
    "300b0603551d0f040403020106300d06092a864886f70d01010b050003820201001fbc525a496d0fab7a62e6074dd994c8c9bdeeb11a34aa" \
    "9f3203c53604826991ca1d02a31c28f9add8dddf63681180902bc5a04a2256c4ea28d44e2343b53af6951db2dce9bffaee596e3fc21f0b02" \
    "58f77f0af3fef4e1bc0d8862d67c8e5c230146be593913bc3ad96807896472f521e4adb74b0af3efeadb48a173a10fcc67577e0dff2feef3" \
    "556e36689dbff5891b95506ea00d2b265a488895a3f66bf4b623466c2f5831c6a58ee455936a620db9f819870a23ee213db19c2fff3ca0c2" \
    "62f22928d1f8c62e8c4aec5e3acdc750e5d44c8c3b43f85a6781b8ae373781f72955389f066e5aca009fece8bd8733ac2ed1250b99c6a95c" \
    "4c0b0cf546cc55c6467f13709e5313ea64872c8ae385e321d3530c21412e061f8c22b6696fc80419bc5901b7424e28fca6721f57c98cfa26" \
    "486e0937764a1ab90be7d59c7ba06eb3cba08d640163a046f2a3aaf23fd783d056af1cae590fff8e1491eefca95c12f3943b8c3876cdf18f" \
    "cd31f03a9a055348e20514397beff7e236aa1b869035b861072aa5bac49af41e4fac8ed8a876fcbeb4b02ab256d9027241d7d2b6167e686a" \
    "328bdc5b16901bf48a0d1448d9a959a8df34f05382d1a00502a18667a16456a0c845c543e899b78959559a6c5543f7067dcebb88c14f6469" \
    "8750488a3fb60a2163d7d504aa470e9c96c69c9fc5ccd84484122743c2c2e5d4df6af8de8952561eb6"

// cacrl.der
#define CA_CRL_DEFINE                                                                                                  \
    "308202dc3081c5300d06092a864886f70d01010b0500308193310b3009060355040613024652310f300d06035504080c064672616e636531" \
    "11300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e747572792043657274696669636174652041" \
    "7574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70632d737570706f72744073797374657265" \
    "6c2e6672170d3138313030343135343735395a180f32313138303931303135343735395a300d06092a864886f70d01010b05000382020100" \
    "26e4802270e2bc1758d7a75294692123e815f4e130a2ed2ef096c232b7ce96700b3764431374cfb8ddc7d23da504dbd9aebba06db3d4e0d4" \
    "dc572b20724856c858e9d17d2ca897cd60e3950d508f5639594e066a1fef4360746297c17d4d2c1ff2afb3e1971c87c19dd77071ec9fae59" \
    "ab3911b3b93f36f2661e46e0dded53ca2fabc36f356ba360837aa8ca673ca7ab3f46fa1ee041b741796b9d30e640d812c31b3d7f45b8a860" \
    "4d1ad19f7a869e52608967b5f0ab73a8bdbbb01ce4dec6d9438ec5d92dc48ba4b4461f9fc5f43625dd2babdfd80e7bfaa79c1de3680233ba" \
    "8a32640f2c1b6056395a261198649d82731fd8ef0697d5d4386bf534b5e1661d56c5974665155545a7ab0eb9ee89f7ca4a0df954355d69a0" \
    "f15fd23162e5c631c4e30b9546e6ba7007068061a7b24c0379f24689fdf3ed6917df2f52b9e5369f838d14a019b1940ae15d95535eb23f71" \
    "f1486c4fd4556701739c76193ce1df3ba354a83f0653d2b90b71ef4c3ebb0efe0ed6390bf4d92bc4528766f9cca6e7a817bd1f3cdd30934a" \
    "3c122f411b594336c7a5fb4c1a786b40a39c458bc6a4afed57409f75c5bed23c379c3fe9836f3dfcce1d64cebd11cb510ae3199156ea1ab2" \
    "976dd2c415a229d8bc2a5ad4753009f4db48fab7bedaf1b529bde7bc7396ec640332c95cf28e4619cae78c40546538322dfeea0fa31d1a8a" \
    "edc9ae42b53ae840"

// cacrl_with_one_revoked_cert.der
#define CA_CRL_WITH_ONE_REVOKED_CERT_DEFINE                                                                            \
    "308203003081e9300d06092a864886f70d01010b0500308193310b3009060355040613024652310f300d06035504080c064672616e636531" \
    "11300f060355040a0c08537973746572656c3136303406035504030c2d53324f50432043656e747572792043657274696669636174652041" \
    "7574686f7269747920666f722054657374733128302606092a864886f70d010901161973326f70632d737570706f72744073797374657265" \
    "6c2e6672170d3233303532353039303430335a170d3235303532343039303430335a30243022021100e4c04af1af0aec36bb0fc73b662443" \
    "67170d3233303532353039303335345a300d06092a864886f70d01010b050003820201004ac7e469f84560345d095278436a99d544ebf6ed" \
    "98bfb2f1eb78be4fd327a86ecd0ddc77b6aa3fe4369c198a2c7093382fa0c4bee25509d4a8103b286b2d6bf27f8fe33149688cb3b9c148a3" \
    "a991c7879af68b767c1f50c16f1f928da57b48c898e10106eb59ab18b1d28582e0bac8fd6a41ae821925ed3c4dffc2a9f58ec67bb47f460f" \
    "3340f9634a5a4d484fd989cb6385714c89e7efc68ead14d16c57fb2b4486b315773e4c8df00a8ef70e9ef7bf2ee7fe2a20bc79c01c968d93" \
    "0451baedd06a3ed31bd0de9adc604cbf291efe7551613b783ec2f5a7eac8754ecdf1b26cc422409ab3255a496f7a0ff8f0de7e4632c3d726" \
    "d4ed4e15d6395ee11a6598c9952cfa73218dc30c15a4bcba607439cd21ed694b13c3bdcceb102b3ccf7dde68f2bb86a06f97c68f99d8c5b3" \
    "35e322fbd43716a58e03269a6e5881df4a510535c02e5c7156e1a7d2b7a466c4c50dc9ace42d46c19d255a7f5fbf7705e11dffbe84231ac0" \
    "ec5e9de83c541c772861f4d29430e695e0964de20698d33eb81c4be3d6493f9113af4086f51d3471f24710df8ae298440b954b8a7122bef9" \
    "85e5ed0ac8b964f703e57ea2faaa95ada41a18f41dd7607490bfefe976ee0b81ec1d4a93a600ac04b9a571004b1ea27c3976a2247b7f11c5" \
    "ba7dddc320ced312a81be32431e4f2c0a72b229b7cb14f904ed55ea593c828549d962140832d8ba219f43ab1"

const char* CA_CRT = CA_CRT_DEFINE;
const size_t CA_CRT_LEN = sizeof(CA_CRT_DEFINE) / 2;

const char* CA_CRL = CA_CRL_WITH_ONE_REVOKED_CERT_DEFINE;
const size_t CA_CRL_LEN = sizeof(CA_CRL_WITH_ONE_REVOKED_CERT_DEFINE) / 2;

SOPC_CertificateList* SOPC_UnhexlifyCertificate(const char* hex_data)
{
    size_t der_len = strlen(hex_data) / 2;
    uint8_t* der_data = SOPC_Calloc(der_len, sizeof(uint8_t));
    ck_assert_ptr_nonnull(der_data);

    ck_assert(unhexlify(hex_data, der_data, der_len) == (int) der_len);
    SOPC_CertificateList* crt = NULL;
    ck_assert(der_len <= SIZE_MAX);
    ck_assert_uint_eq(SOPC_STATUS_OK,
                      SOPC_KeyManager_Certificate_CreateOrAddFromDER(der_data, (uint32_t) der_len, &crt));
    SOPC_Free(der_data);

    return crt;
}

SOPC_CRLList* SOPC_UnhexlifyCRL(const char* hex_data)
{
    size_t der_len = strlen(hex_data) / 2;
    uint8_t* der_data = SOPC_Calloc(der_len, sizeof(uint8_t));
    ck_assert_ptr_nonnull(der_data);

    SOPC_CRLList* crl = NULL;
    ck_assert(unhexlify(hex_data, der_data, der_len) == (int) der_len);
    ck_assert(der_len <= SIZE_MAX);
    ck_assert_uint_eq(SOPC_STATUS_OK, SOPC_KeyManager_CRL_CreateOrAddFromDER(der_data, (uint32_t) der_len, &crl));
    SOPC_Free(der_data);

    return crl;
}
